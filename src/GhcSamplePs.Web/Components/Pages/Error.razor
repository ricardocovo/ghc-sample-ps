@page "/Error"
@page "/Error/{StatusCode:int}"
@using System.Diagnostics

<PageTitle>@GetPageTitle()</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
    <MudPaper Elevation="2" Class="pa-6">
        <MudStack AlignItems="AlignItems.Center" Spacing="4">
            @* Error Icon *@
            <MudIcon Icon="@GetErrorIcon()" 
                     Color="@GetErrorColor()" 
                     Size="Size.Large" 
                     Style="font-size: 5rem;" />
            
            @* Error Title *@
            <MudText Typo="Typo.h4" Color="@GetErrorColor()" Align="Align.Center">
                @GetErrorTitle()
            </MudText>

            @* User-friendly error message *@
            <MudText Typo="Typo.body1" Align="Align.Center" Class="mb-2">
                @GetErrorMessage()
            </MudText>

            @* Additional helpful information based on error type *@
            @if (IsAuthError)
            {
                <MudAlert Severity="Severity.Info" Class="mt-2" Style="max-width: 500px;">
                    <MudText Typo="Typo.body2">
                        <strong>Having trouble signing in?</strong> Try clearing your browser cookies 
                        or using a private/incognito window. If the problem persists, please contact support.
                    </MudText>
                </MudAlert>
            }
            else if (IsMaintenanceError)
            {
                <MudAlert Severity="Severity.Warning" Class="mt-2" Style="max-width: 500px;">
                    <MudText Typo="Typo.body2">
                        <strong>Scheduled Maintenance:</strong> We're performing system updates to improve your experience.
                        This typically takes a few minutes. Thank you for your patience!
                    </MudText>
                </MudAlert>
            }

            @* Request ID for support purposes (shown subtly) *@
            @if (ShowRequestId)
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                    Reference ID: @RequestId
                </MudText>
            }

            <MudDivider Class="my-4" Style="width: 100%;" />

            @* Action buttons *@
            <MudStack Row="true" Spacing="2" Justify="Justify.Center">
                @if (ShowRetryOption)
                {
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               StartIcon="@Icons.Material.Filled.Refresh"
                               OnClick="RetryAction">
                        Try Again
                    </MudButton>
                }

                <MudButton Variant="@(ShowRetryOption ? Variant.Outlined : Variant.Filled)" 
                           Color="Color.Primary" 
                           StartIcon="@Icons.Material.Filled.Home"
                           Href="/">
                    Go to Home
                </MudButton>

                @if (IsAuthError)
                {
                    <MudButton Variant="Variant.Outlined" 
                               Color="Color.Primary" 
                               StartIcon="@Icons.Material.Filled.Login"
                               Href="MicrosoftIdentity/Account/SignIn">
                        Sign In
                    </MudButton>
                }
            </MudStack>

            @* Help text *@
            <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center" Class="mt-4">
                If you continue to experience issues, please contact our support team.
            </MudText>
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    [Parameter]
    public int? StatusCode { get; set; }

    [CascadingParameter]
    private HttpContext? HttpContext { get; set; }

    [SupplyParameterFromQuery]
    private string? ErrorType { get; set; }

    private string? RequestId { get; set; }
    private bool ShowRequestId => !string.IsNullOrEmpty(RequestId);

    private bool IsAuthError => ErrorType == "auth" || 
                                StatusCode == 401 || 
                                StatusCode == 403 ||
                                ErrorType == "signin" ||
                                ErrorType == "identity";

    private bool IsMaintenanceError => StatusCode == 503 || ErrorType == "maintenance";
    private bool IsNotFoundError => StatusCode == 404;
    private bool IsServerError => StatusCode >= 500 && StatusCode < 600;
    private bool ShowRetryOption => IsServerError || IsMaintenanceError;

    protected override void OnInitialized()
    {
        RequestId = Activity.Current?.Id ?? HttpContext?.TraceIdentifier;
        
        // Try to determine status code from HttpContext if not provided
        if (!StatusCode.HasValue && HttpContext?.Response.StatusCode is int code && code >= 400)
        {
            StatusCode = code;
        }
    }

    private string GetPageTitle() => StatusCode switch
    {
        401 => "Authentication Required",
        403 => "Access Denied",
        404 => "Page Not Found",
        500 => "Server Error",
        503 => "Service Unavailable",
        _ when IsAuthError => "Authentication Error",
        _ when IsMaintenanceError => "Maintenance",
        _ => "Error"
    };

    private string GetErrorIcon() => StatusCode switch
    {
        401 => Icons.Material.Filled.LockPerson,
        403 => Icons.Material.Filled.Block,
        404 => Icons.Material.Filled.SearchOff,
        503 => Icons.Material.Filled.Construction,
        _ when IsAuthError => Icons.Material.Filled.PersonOff,
        _ when IsMaintenanceError => Icons.Material.Filled.Engineering,
        _ => Icons.Material.Filled.Error
    };

    private Color GetErrorColor() => StatusCode switch
    {
        401 or 403 => Color.Warning,
        404 => Color.Info,
        503 => Color.Warning,
        _ when IsAuthError => Color.Warning,
        _ when IsMaintenanceError => Color.Warning,
        _ => Color.Error
    };

    private string GetErrorTitle() => StatusCode switch
    {
        401 => "Authentication Required",
        403 => "Access Denied",
        404 => "Page Not Found",
        500 => "Something Went Wrong",
        503 => "Service Temporarily Unavailable",
        _ when IsAuthError => "Sign-In Issue",
        _ when IsMaintenanceError => "Under Maintenance",
        _ => "Oops! Something went wrong"
    };

    private string GetErrorMessage() => StatusCode switch
    {
        401 => "You need to sign in to access this page. Please authenticate to continue.",
        403 => "You don't have permission to access this resource. If you believe this is an error, please contact your administrator.",
        404 => "The page you're looking for doesn't exist or may have been moved. Please check the URL or navigate using the menu.",
        500 => "We encountered an unexpected error while processing your request. Our team has been notified and is working on it.",
        503 => "The service is temporarily unavailable due to maintenance or high traffic. Please try again in a few moments.",
        _ when IsAuthError => "We encountered an issue with your authentication. This might be a temporary problem with our identity service.",
        _ when IsMaintenanceError => "We're currently performing scheduled maintenance to improve our services. Please check back soon.",
        _ => "We're sorry, but something unexpected happened. Please try again or return to the home page."
    };

    [Inject]
    private NavigationManager NavigationManager { get; set; } = default!;

    private void RetryAction()
    {
        // Get the referring page from the HttpContext headers
        var referer = HttpContext?.Request.Headers.Referer.ToString();
        
        if (!string.IsNullOrEmpty(referer))
        {
            // Navigate back to the referring page
            NavigationManager.NavigateTo(referer, forceLoad: true);
        }
        else
        {
            // Reload the current page if no referer is available
            NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
        }
    }
}
