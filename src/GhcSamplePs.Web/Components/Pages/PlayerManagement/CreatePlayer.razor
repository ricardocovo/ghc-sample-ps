@page "/players/create"
@using GhcSamplePs.Core.Services.Interfaces
@using GhcSamplePs.Core.Models.PlayerManagement.DTOs
@using GhcSamplePs.Core.Validation
@inject IPlayerService PlayerService
@inject NavigationManager NavigationManager
@inject ICurrentUserProvider CurrentUserProvider

<PageTitle>Create Player</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudPaper Elevation="2" Class="pa-4">
        @* Header *@
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
            <MudIcon Icon="@Icons.Material.Filled.PersonAdd" Size="Size.Large" />
            <MudText Typo="Typo.h5">Create Player</MudText>
        </MudStack>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
            Enter the player details below
        </MudText>

        @* Error display *@
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4" ShowCloseIcon="true" CloseIconClicked="() => _errorMessage = null">
                @_errorMessage
            </MudAlert>
        }

        @* Form *@
        <MudForm @ref="_form" @bind-IsValid="_formIsValid">
            @* Name field *@
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-1">
                <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Color="Color.Secondary" />
                <MudText Typo="Typo.body2">Name</MudText>
            </MudStack>
            <MudTextField @bind-Value="_name"
                          Placeholder="Enter player name"
                          Variant="Variant.Outlined"
                          Required="true"
                          RequiredError="Name is required"
                          MaxLength="200"
                          Counter="200"
                          Immediate="true"
                          Class="mb-4" />

            @* Date of Birth field *@
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-1">
                <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Color="Color.Secondary" />
                <MudText Typo="Typo.body2">Date of Birth</MudText>
            </MudStack>
            <MudDatePicker @bind-Date="_dateOfBirth"
                           Placeholder="mm/dd/yyyy"
                           Variant="Variant.Outlined"
                           DateFormat="MM/dd/yyyy"
                           MaxDate="DateTime.Today.AddDays(-1)"
                           MinDate="DateTime.Today.AddYears(-100)"
                           Required="true"
                           RequiredError="Date of birth is required"
                           Class="mb-4" />

            @* Age display (calculated) *@
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-1">
                <MudIcon Icon="@Icons.Material.Filled.Cake" Size="Size.Small" Color="Color.Secondary" />
                <MudText Typo="Typo.body2">Age</MudText>
            </MudStack>
            <MudTextField Value="@CalculatedAge"
                          Placeholder="Auto-calculated from DOB"
                          Variant="Variant.Outlined"
                          ReadOnly="true"
                          Disabled="true"
                          Class="mb-4" />

            @* Gender field *@
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-1">
                <MudIcon Icon="@Icons.Material.Filled.Wc" Size="Size.Small" Color="Color.Secondary" />
                <MudText Typo="Typo.body2">Gender</MudText>
            </MudStack>
            <MudSelect @bind-Value="_gender"
                       Placeholder="Select gender"
                       Variant="Variant.Outlined"
                       Class="mb-4">
                <MudSelectItem T="string?" Value="@((string?)null)">Select gender</MudSelectItem>
                @foreach (var option in PlayerValidator.ValidGenderOptions)
                {
                    <MudSelectItem Value="@option">@option</MudSelectItem>
                }
            </MudSelect>

            @* Submit button *@
            <MudButton Variant="Variant.Filled"
                       Color="Color.Dark"
                       FullWidth="true"
                       Disabled="@(!_formIsValid || _isSaving)"
                       OnClick="HandleSubmit"
                       Class="mt-4">
                @if (_isSaving)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Creating...</span>
                }
                else
                {
                    <span>Create Player</span>
                }
            </MudButton>

            @* Cancel button *@
            <MudButton Variant="Variant.Text"
                       Color="Color.Default"
                       FullWidth="true"
                       OnClick="HandleCancel"
                       Disabled="@_isSaving"
                       Class="mt-2">
                Cancel
            </MudButton>
        </MudForm>
    </MudPaper>
</MudContainer>

@code {
    private MudForm? _form;
    private bool _formIsValid;
    private bool _isSaving;
    private string? _errorMessage;

    private string _name = string.Empty;
    private DateTime? _dateOfBirth;
    private string? _gender;

    private string CalculatedAge
    {
        get
        {
            if (!_dateOfBirth.HasValue)
            {
                return string.Empty;
            }

            var today = DateTime.UtcNow.Date;
            var dob = _dateOfBirth.Value;
            var age = today.Year - dob.Year;
            if (dob.Date > today.AddYears(-age))
            {
                age--;
            }
            return $"{age} years";
        }
    }

    private async Task HandleSubmit()
    {
        if (_form is null)
        {
            return;
        }

        await _form.Validate();

        if (!_formIsValid || !_dateOfBirth.HasValue)
        {
            return;
        }

        _isSaving = true;
        _errorMessage = null;

        try
        {
            var currentUserId = CurrentUserProvider.GetCurrentUser()?.Identity?.Name ?? "system";

            var createDto = new CreatePlayerDto
            {
                UserId = currentUserId,
                Name = _name.Trim(),
                DateOfBirth = _dateOfBirth.Value,
                Gender = string.IsNullOrWhiteSpace(_gender) ? null : _gender,
                PhotoUrl = null
            };

            var result = await PlayerService.CreatePlayerAsync(createDto, currentUserId);

            if (result.Success && result.Data is not null)
            {
                NavigationManager.NavigateTo($"/players/edit/{result.Data.Id}");
            }
            else if (result.ValidationErrors.Count > 0)
            {
                var errors = result.ValidationErrors.SelectMany(e => e.Value);
                _errorMessage = string.Join(" ", errors);
            }
            else
            {
                _errorMessage = result.ErrorMessages.FirstOrDefault() ?? "Unable to create player.";
            }
        }
        catch (Exception)
        {
            _errorMessage = "An unexpected error occurred while creating the player.";
        }
        finally
        {
            _isSaving = false;
        }
    }

    private void HandleCancel()
    {
        NavigationManager.NavigateTo("/players");
    }
}
