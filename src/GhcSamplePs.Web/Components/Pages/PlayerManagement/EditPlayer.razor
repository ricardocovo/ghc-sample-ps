@page "/players/edit/{Id:int}"
@using GhcSamplePs.Core.Services.Interfaces
@using GhcSamplePs.Core.Models.PlayerManagement.DTOs
@using GhcSamplePs.Core.Validation
@using GhcSamplePs.Web.Helpers
@inject IPlayerService PlayerService
@inject ITeamPlayerService TeamPlayerService
@inject IPlayerStatisticService PlayerStatisticService
@inject NavigationManager NavigationManager
@inject ICurrentUserProvider CurrentUserProvider
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Edit Player</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    @* Back navigation and player name header *@
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-4">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                       OnClick="NavigateBack"
                       Size="Size.Medium" />
        <MudText Typo="Typo.h5">@(_player?.Name ?? "Edit Player")</MudText>
    </MudStack>

    @* Loading state *@
    @if (_isLoading)
    {
        <MudPaper Elevation="2" Class="pa-4">
            <MudStack AlignItems="AlignItems.Center" Class="my-8">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">Loading player...</MudText>
            </MudStack>
        </MudPaper>
    }
    @* Error state for player not found or unauthorized *@
    else if (_player is null)
    {
        <MudPaper Elevation="2" Class="pa-4">
            <MudAlert Severity="Severity.Error">
                @(_errorMessage ?? "Player not found.")
            </MudAlert>
            <MudButton Variant="Variant.Text"
                       Color="Color.Primary"
                       OnClick="NavigateBack"
                       Class="mt-4">
                Back to Players
            </MudButton>
        </MudPaper>
    }
    @* Edit form with tabs *@
    else
    {
        <MudTabs Elevation="2"
                 Rounded="true"
                 ApplyEffectsToContainer="true"
                 PanelClass="pa-4"
                 ActivePanelIndex="@_activeTabIndex"
                 ActivePanelIndexChanged="OnTabChanged">
            @* Player Info Tab *@
            <MudTabPanel Text="Player" Icon="@Icons.Material.Filled.Person">
                <MudPaper Elevation="0">
                    @* Section header *@
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.Person" />
                        <MudText Typo="Typo.h6">Player Information</MudText>
                    </MudStack>

                    @* Error display *@
                    @if (!string.IsNullOrEmpty(_errorMessage))
                    {
                        <MudAlert Severity="Severity.Error" Class="mb-4" ShowCloseIcon="true" CloseIconClicked="() => _errorMessage = null">
                            @_errorMessage
                        </MudAlert>
                    }

                    @* Form *@
                    <MudForm @ref="_form" @bind-IsValid="_formIsValid">
                        @* Name field *@
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-1">
                            <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Color="Color.Secondary" />
                            <MudText Typo="Typo.body2">Name</MudText>
                        </MudStack>
                        <MudTextField @bind-Value="_name"
                                      Placeholder="Enter player name"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      RequiredError="Name is required"
                                      MaxLength="200"
                                      Counter="200"
                                      Immediate="true"
                                      Class="mb-4" />

                        @* Date of Birth field *@
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-1">
                            <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Color="Color.Secondary" />
                            <MudText Typo="Typo.body2">Date of Birth</MudText>
                        </MudStack>
                        <MudDatePicker @bind-Date="_dateOfBirth"
                                       Placeholder="mm/dd/yyyy"
                                       Variant="Variant.Outlined"
                                       DateFormat="MM/dd/yyyy"
                                       MaxDate="DateTime.Today.AddDays(-1)"
                                       MinDate="DateTime.Today.AddYears(-100)"
                                       Required="true"
                                       RequiredError="Date of birth is required"
                                       Class="mb-4" />

                        @* Age display (calculated) *@
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-1">
                            <MudIcon Icon="@Icons.Material.Filled.Cake" Size="Size.Small" Color="Color.Secondary" />
                            <MudText Typo="Typo.body2">Age</MudText>
                        </MudStack>
                        <MudTextField Value="@AgeCalculationHelper.FormatAge(_dateOfBirth)"
                                      Placeholder="Auto-calculated from DOB"
                                      Variant="Variant.Outlined"
                                      ReadOnly="true"
                                      Disabled="true"
                                      Class="mb-4" />

                        @* Gender field *@
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-1">
                            <MudIcon Icon="@Icons.Material.Filled.Wc" Size="Size.Small" Color="Color.Secondary" />
                            <MudText Typo="Typo.body2">Gender</MudText>
                        </MudStack>
                        <MudSelect @bind-Value="_gender"
                                   Placeholder="Select gender"
                                   Variant="Variant.Outlined"
                                   Class="mb-4">
                            <MudSelectItem T="string?" Value="@((string?)null)">Select gender</MudSelectItem>
                            @foreach (var option in PlayerValidator.ValidGenderOptions)
                            {
                                <MudSelectItem Value="@option">@option</MudSelectItem>
                            }
                        </MudSelect>
                    </MudForm>

                    @* Action buttons *@
                    <MudStack Row="true" Spacing="2" Class="mt-4">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Error"
                                   StartIcon="@Icons.Material.Filled.Delete"
                                   OnClick="HandleDelete"
                                   Disabled="@(_isSaving || _isDeleting)">
                            @if (_isDeleting)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                <span>Deleting...</span>
                            }
                            else
                            {
                                <span>Delete</span>
                            }
                        </MudButton>
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Default"
                                   OnClick="NavigateBack"
                                   Disabled="@(_isSaving || _isDeleting)">
                            Cancel
                        </MudButton>
                        <MudSpacer />
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Dark"
                                   OnClick="HandleUpdate"
                                   Disabled="@(!_formIsValid || _isSaving || _isDeleting)">
                            @if (_isSaving)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                <span>Updating...</span>
                            }
                            else
                            {
                                <span>Update</span>
                            }
                        </MudButton>
                    </MudStack>
                </MudPaper>
            </MudTabPanel>

            @* Teams Tab *@
            <MudTabPanel Text="Teams" Icon="@Icons.Material.Filled.Groups">
                <MudPaper Elevation="0">
                    @* Section header *@
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.Groups" />
                        <MudText Typo="Typo.h6">Team Assignments</MudText>
                        <MudSpacer />
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   OnClick="OpenAddTeamDialog"
                                   Disabled="@_isLoadingTeams">
                            Add Team
                        </MudButton>
                    </MudStack>

                    @* Error display *@
                    @if (!string.IsNullOrEmpty(_teamErrorMessage))
                    {
                        <MudAlert Severity="Severity.Error" Class="mb-4" ShowCloseIcon="true" CloseIconClicked="() => _teamErrorMessage = null">
                            @_teamErrorMessage
                        </MudAlert>
                    }

                    @* Loading state *@
                    @if (_isLoadingTeams)
                    {
                        <MudStack AlignItems="AlignItems.Center" Class="my-8">
                            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">Loading team assignments...</MudText>
                        </MudStack>
                    }
                    @* Empty state *@
                    else if (_teams.Count == 0)
                    {
                        <MudStack AlignItems="AlignItems.Center" Class="my-8">
                            <MudIcon Icon="@Icons.Material.Filled.Groups" Size="Size.Large" Color="Color.Secondary" />
                            <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-2">No team assignments yet</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Add this player to a team to get started.
                            </MudText>
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Add"
                                       OnClick="OpenAddTeamDialog"
                                       Class="mt-4">
                                Add Team
                            </MudButton>
                        </MudStack>
                    }
                    @* Team list *@
                    else
                    {
                        <MudTable Items="@_teams" Hover="true" Elevation="0" Dense="true">
                            <HeaderContent>
                                <MudTh>Team Name</MudTh>
                                <MudTh>Championship</MudTh>
                                <MudTh>Joined</MudTh>
                                <MudTh>Left</MudTh>
                                <MudTh>Status</MudTh>
                                <MudTh Style="width: 120px;">Actions</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Team Name">@context.TeamName</MudTd>
                                <MudTd DataLabel="Championship">@context.ChampionshipName</MudTd>
                                <MudTd DataLabel="Joined">@context.JoinedDate.ToString("MM/dd/yyyy")</MudTd>
                                <MudTd DataLabel="Left">@(context.LeftDate?.ToString("MM/dd/yyyy") ?? "-")</MudTd>
                                <MudTd DataLabel="Status">
                                    @if (context.IsActive)
                                    {
                                        <MudChip T="string" Color="Color.Success" Size="Size.Small">Active</MudChip>
                                    }
                                    else
                                    {
                                        <MudChip T="string" Color="Color.Default" Size="Size.Small">Inactive</MudChip>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Actions">
                                    <MudStack Row="true" Spacing="1">
                                        <MudTooltip Text="Edit">
                                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                           Size="Size.Small"
                                                           Color="Color.Primary"
                                                           OnClick="() => OpenEditTeamDialog(context)" />
                                        </MudTooltip>
                                        @if (context.IsActive)
                                        {
                                            <MudTooltip Text="Remove from team">
                                                <MudIconButton Icon="@Icons.Material.Filled.PersonRemove"
                                                               Size="Size.Small"
                                                               Color="Color.Error"
                                                               OnClick="() => OpenRemoveTeamDialog(context)" />
                                            </MudTooltip>
                                        }
                                    </MudStack>
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    }
                </MudPaper>
            </MudTabPanel>

            @* Stats Tab *@
            <MudTabPanel Text="Stats" Icon="@Icons.Material.Filled.BarChart">
                <MudPaper Elevation="0">
                    @* Section header *@
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.BarChart" />
                        <MudText Typo="Typo.h6">Game Statistics</MudText>
                        <MudSpacer />
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   OnClick="OpenAddStatisticDialog"
                                   Disabled="@(_isLoadingStatistics || _teams.Count == 0)">
                            Add Statistics
                        </MudButton>
                    </MudStack>

                    @* Error display *@
                    @if (!string.IsNullOrEmpty(_statisticsErrorMessage))
                    {
                        <MudAlert Severity="Severity.Error" Class="mb-4" ShowCloseIcon="true" CloseIconClicked="() => _statisticsErrorMessage = null">
                            @_statisticsErrorMessage
                        </MudAlert>
                    }

                    @* Loading state *@
                    @if (_isLoadingStatistics)
                    {
                        <MudStack AlignItems="AlignItems.Center" Class="my-8">
                            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">Loading statistics...</MudText>
                        </MudStack>
                    }
                    @* Empty state *@
                    else if (_statistics.Count == 0)
                    {
                        <MudStack AlignItems="AlignItems.Center" Class="my-8">
                            <MudIcon Icon="@Icons.Material.Filled.SportsSoccer" Size="Size.Large" Color="Color.Secondary" />
                            <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-2">No statistics recorded yet</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Record game statistics to track performance over time.
                            </MudText>
                            @if (_teams.Count > 0)
                            {
                                <MudButton Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.Add"
                                           OnClick="OpenAddStatisticDialog"
                                           Class="mt-4">
                                    Add Statistics
                                </MudButton>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Color="Color.Warning" Class="mt-2">
                                    Add the player to a team first to record statistics.
                                </MudText>
                            }
                        </MudStack>
                    }
                    @* Statistics content *@
                    else
                    {
                        @* Summary Cards *@
                        <MudGrid Spacing="3" Class="mb-4">
                            <MudItem xs="6" sm="3">
                                <MudPaper Elevation="1" Class="pa-4 text-center">
                                    <MudIcon Icon="@Icons.Material.Filled.SportsSoccer" Color="Color.Primary" Size="Size.Medium" />
                                    <MudText Typo="Typo.h4" Color="Color.Primary" Class="mt-2">@_aggregates.GameCount</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">Games Played</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudPaper Elevation="1" Class="pa-4 text-center">
                                    <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Color="Color.Success" Size="Size.Medium" />
                                    <MudText Typo="Typo.h4" Color="Color.Success" Class="mt-2">@_aggregates.TotalGoals</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">Total Goals</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudPaper Elevation="1" Class="pa-4 text-center">
                                    <MudIcon Icon="@Icons.Material.Filled.Handshake" Color="Color.Info" Size="Size.Medium" />
                                    <MudText Typo="Typo.h4" Color="Color.Info" Class="mt-2">@_aggregates.TotalAssists</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">Total Assists</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudPaper Elevation="1" Class="pa-4 text-center">
                                    <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Color="Color.Warning" Size="Size.Medium" />
                                    <MudText Typo="Typo.h4" Color="Color.Warning" Class="mt-2">@_aggregates.AverageGoals.ToString("F2")</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">Avg Goals/Game</MudText>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>

                        @* Statistics Table *@
                        <MudTable Items="@_statistics" Hover="true" Elevation="0" Dense="true">
                            <HeaderContent>
                                <MudTh>Game Date</MudTh>
                                <MudTh>Team</MudTh>
                                <MudTh>Championship</MudTh>
                                <MudTh>Minutes</MudTh>
                                <MudTh>Goals</MudTh>
                                <MudTh>Assists</MudTh>
                                <MudTh>Starter</MudTh>
                                <MudTh>Jersey</MudTh>
                                <MudTh Style="width: 120px;">Actions</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Game Date">@context.GameDate.ToString("MM/dd/yyyy")</MudTd>
                                <MudTd DataLabel="Team">@context.TeamName</MudTd>
                                <MudTd DataLabel="Championship">@context.ChampionshipName</MudTd>
                                <MudTd DataLabel="Minutes">@context.MinutesPlayed</MudTd>
                                <MudTd DataLabel="Goals">@context.Goals</MudTd>
                                <MudTd DataLabel="Assists">@context.Assists</MudTd>
                                <MudTd DataLabel="Starter">
                                    @if (context.IsStarter)
                                    {
                                        <MudChip T="string" Color="Color.Success" Size="Size.Small">Starter</MudChip>
                                    }
                                    else
                                    {
                                        <MudChip T="string" Color="Color.Default" Size="Size.Small">Sub</MudChip>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Jersey">#@context.JerseyNumber</MudTd>
                                <MudTd DataLabel="Actions">
                                    <MudStack Row="true" Spacing="1">
                                        <MudTooltip Text="Edit">
                                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                           Size="Size.Small"
                                                           Color="Color.Primary"
                                                           OnClick="() => OpenEditStatisticDialog(context)" />
                                        </MudTooltip>
                                        <MudTooltip Text="Delete">
                                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                           Size="Size.Small"
                                                           Color="Color.Error"
                                                           OnClick="() => OpenDeleteStatisticDialog(context)" />
                                        </MudTooltip>
                                    </MudStack>
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    }
                </MudPaper>
            </MudTabPanel>
        </MudTabs>
    }

    @* Add Team Dialog *@
    <MudDialog @bind-Visible="_showAddTeamDialog">
        <TitleContent>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Add" />
                <MudText Typo="Typo.h6">Add Team Assignment</MudText>
            </MudStack>
        </TitleContent>
        <DialogContent>
            <MudForm @ref="_addTeamForm" @bind-IsValid="_addTeamFormIsValid">
                <MudTextField @bind-Value="_addTeamName"
                              Label="Team Name"
                              Variant="Variant.Outlined"
                              Required="true"
                              RequiredError="Team name is required"
                              MaxLength="200"
                              Counter="200"
                              Immediate="true"
                              Class="mb-4" />
                <MudTextField @bind-Value="_addChampionshipName"
                              Label="Championship Name"
                              Variant="Variant.Outlined"
                              Required="true"
                              RequiredError="Championship name is required"
                              MaxLength="200"
                              Counter="200"
                              Immediate="true"
                              Class="mb-4" />
                <MudDatePicker @bind-Date="_addJoinedDate"
                               Label="Joined Date"
                               Variant="Variant.Outlined"
                               DateFormat="MM/dd/yyyy"
                               MaxDate="DateTime.Today"
                               Required="true"
                               RequiredError="Joined date is required" />
            </MudForm>
            @if (!string.IsNullOrEmpty(_addTeamErrorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mt-4">@_addTeamErrorMessage</MudAlert>
            }
        </DialogContent>
        <DialogActions>
            <MudButton OnClick="CloseAddTeamDialog" Disabled="@_isSavingTeam">Cancel</MudButton>
            <MudButton Color="Color.Primary"
                       Variant="Variant.Filled"
                       OnClick="HandleAddTeam"
                       Disabled="@(!_addTeamFormIsValid || _isSavingTeam)">
                @if (_isSavingTeam)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Adding...</span>
                }
                else
                {
                    <span>Add</span>
                }
            </MudButton>
        </DialogActions>
    </MudDialog>

    @* Edit Team Dialog *@
    <MudDialog @bind-Visible="_showEditTeamDialog">
        <TitleContent>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Edit" />
                <MudText Typo="Typo.h6">Edit Team Assignment</MudText>
            </MudStack>
        </TitleContent>
        <DialogContent>
            <MudForm @ref="_editTeamForm" @bind-IsValid="_editTeamFormIsValid">
                <MudTextField Value="@_editingTeam?.TeamName"
                              Label="Team Name"
                              Variant="Variant.Outlined"
                              ReadOnly="true"
                              Disabled="true"
                              Class="mb-4" />
                <MudTextField Value="@_editingTeam?.ChampionshipName"
                              Label="Championship Name"
                              Variant="Variant.Outlined"
                              ReadOnly="true"
                              Disabled="true"
                              Class="mb-4" />
                <MudTextField Value="@(_editingTeam?.JoinedDate.ToString("MM/dd/yyyy"))"
                              Label="Joined Date"
                              Variant="Variant.Outlined"
                              ReadOnly="true"
                              Disabled="true"
                              Class="mb-4" />
                <MudDatePicker @bind-Date="_editLeftDate"
                               Label="Left Date (leave empty if still active)"
                               Variant="Variant.Outlined"
                               DateFormat="MM/dd/yyyy"
                               MaxDate="DateTime.Today"
                               MinDate="@(_editingTeam?.JoinedDate.AddDays(1))"
                               Clearable="true" />
            </MudForm>
            @if (!string.IsNullOrEmpty(_editTeamErrorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mt-4">@_editTeamErrorMessage</MudAlert>
            }
        </DialogContent>
        <DialogActions>
            <MudButton OnClick="CloseEditTeamDialog" Disabled="@_isSavingTeam">Cancel</MudButton>
            <MudButton Color="Color.Primary"
                       Variant="Variant.Filled"
                       OnClick="HandleEditTeam"
                       Disabled="@_isSavingTeam">
                @if (_isSavingTeam)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Saving...</span>
                }
                else
                {
                    <span>Save</span>
                }
            </MudButton>
        </DialogActions>
    </MudDialog>

    @* Remove Team Confirmation Dialog *@
    <MudDialog @bind-Visible="_showRemoveTeamDialog">
        <TitleContent>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.PersonRemove" Color="Color.Error" />
                <MudText Typo="Typo.h6">Remove from Team</MudText>
            </MudStack>
        </TitleContent>
        <DialogContent>
            <MudText Typo="Typo.body1" Class="mb-2">
                Are you sure you want to remove this player from <strong>@_removingTeam?.TeamName</strong> in <strong>@_removingTeam?.ChampionshipName</strong>?
            </MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                This will mark the player as having left the team today. The team assignment record will be preserved for historical purposes.
            </MudText>
            @if (!string.IsNullOrEmpty(_removeTeamErrorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mt-4">@_removeTeamErrorMessage</MudAlert>
            }
        </DialogContent>
        <DialogActions>
            <MudButton OnClick="CloseRemoveTeamDialog" Disabled="@_isSavingTeam">Cancel</MudButton>
            <MudButton Color="Color.Error"
                       Variant="Variant.Filled"
                       OnClick="HandleRemoveTeam"
                       Disabled="@_isSavingTeam">
                @if (_isSavingTeam)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Removing...</span>
                }
                else
                {
                    <span>Remove</span>
                }
            </MudButton>
        </DialogActions>
    </MudDialog>

    @* Add Statistic Dialog *@
    <MudDialog @bind-Visible="_showAddStatisticDialog">
        <TitleContent>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Add" />
                <MudText Typo="Typo.h6">Add Statistics</MudText>
            </MudStack>
        </TitleContent>
        <DialogContent>
            <MudForm @ref="_addStatisticForm" @bind-IsValid="_addStatisticFormIsValid">
                <MudSelect @bind-Value="_addStatisticTeamPlayerId"
                           Label="Team"
                           Variant="Variant.Outlined"
                           Required="true"
                           RequiredError="Team is required"
                           Class="mb-4">
                    @foreach (var team in _teams.Where(t => t.IsActive))
                    {
                        <MudSelectItem Value="@team.TeamPlayerId">@team.TeamName (@team.ChampionshipName)</MudSelectItem>
                    }
                </MudSelect>
                <MudDatePicker @bind-Date="_addStatisticGameDate"
                               Label="Game Date"
                               Variant="Variant.Outlined"
                               DateFormat="MM/dd/yyyy"
                               MaxDate="DateTime.Today"
                               Required="true"
                               RequiredError="Game date is required"
                               Class="mb-4" />
                <MudNumericField @bind-Value="_addStatisticMinutesPlayed"
                                 Label="Minutes Played"
                                 Variant="Variant.Outlined"
                                 Min="0"
                                 Max="120"
                                 Required="true"
                                 RequiredError="Minutes played is required"
                                 Class="mb-4" />
                <MudCheckBox @bind-Value="_addStatisticIsStarter"
                             Label="Is Starter"
                             Color="Color.Primary"
                             Class="mb-4" />
                <MudNumericField @bind-Value="_addStatisticJerseyNumber"
                                 Label="Jersey Number"
                                 Variant="Variant.Outlined"
                                 Min="1"
                                 Max="99"
                                 Required="true"
                                 RequiredError="Jersey number is required"
                                 Class="mb-4" />
                <MudNumericField @bind-Value="_addStatisticGoals"
                                 Label="Goals"
                                 Variant="Variant.Outlined"
                                 Min="0"
                                 Required="true"
                                 RequiredError="Goals is required"
                                 Class="mb-4" />
                <MudNumericField @bind-Value="_addStatisticAssists"
                                 Label="Assists"
                                 Variant="Variant.Outlined"
                                 Min="0"
                                 Required="true"
                                 RequiredError="Assists is required" />
            </MudForm>
            @if (!string.IsNullOrEmpty(_addStatisticErrorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mt-4">@_addStatisticErrorMessage</MudAlert>
            }
        </DialogContent>
        <DialogActions>
            <MudButton OnClick="CloseAddStatisticDialog" Disabled="@_isSavingStatistic">Cancel</MudButton>
            <MudButton Color="Color.Primary"
                       Variant="Variant.Filled"
                       OnClick="HandleAddStatistic"
                       Disabled="@(!_addStatisticFormIsValid || _isSavingStatistic || _addStatisticTeamPlayerId == 0)">
                @if (_isSavingStatistic)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Adding...</span>
                }
                else
                {
                    <span>Add</span>
                }
            </MudButton>
        </DialogActions>
    </MudDialog>

    @* Edit Statistic Dialog *@
    <MudDialog @bind-Visible="_showEditStatisticDialog">
        <TitleContent>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Edit" />
                <MudText Typo="Typo.h6">Edit Statistics</MudText>
            </MudStack>
        </TitleContent>
        <DialogContent>
            <MudForm @ref="_editStatisticForm" @bind-IsValid="_editStatisticFormIsValid">
                <MudSelect @bind-Value="_editStatisticTeamPlayerId"
                           Label="Team"
                           Variant="Variant.Outlined"
                           Required="true"
                           RequiredError="Team is required"
                           Class="mb-4">
                    @foreach (var team in _teams.Where(t => t.IsActive))
                    {
                        <MudSelectItem Value="@team.TeamPlayerId">@team.TeamName (@team.ChampionshipName)</MudSelectItem>
                    }
                </MudSelect>
                <MudDatePicker @bind-Date="_editStatisticGameDate"
                               Label="Game Date"
                               Variant="Variant.Outlined"
                               DateFormat="MM/dd/yyyy"
                               MaxDate="DateTime.Today"
                               Required="true"
                               RequiredError="Game date is required"
                               Class="mb-4" />
                <MudNumericField @bind-Value="_editStatisticMinutesPlayed"
                                 Label="Minutes Played"
                                 Variant="Variant.Outlined"
                                 Min="0"
                                 Max="120"
                                 Required="true"
                                 RequiredError="Minutes played is required"
                                 Class="mb-4" />
                <MudCheckBox @bind-Value="_editStatisticIsStarter"
                             Label="Is Starter"
                             Color="Color.Primary"
                             Class="mb-4" />
                <MudNumericField @bind-Value="_editStatisticJerseyNumber"
                                 Label="Jersey Number"
                                 Variant="Variant.Outlined"
                                 Min="1"
                                 Max="99"
                                 Required="true"
                                 RequiredError="Jersey number is required"
                                 Class="mb-4" />
                <MudNumericField @bind-Value="_editStatisticGoals"
                                 Label="Goals"
                                 Variant="Variant.Outlined"
                                 Min="0"
                                 Required="true"
                                 RequiredError="Goals is required"
                                 Class="mb-4" />
                <MudNumericField @bind-Value="_editStatisticAssists"
                                 Label="Assists"
                                 Variant="Variant.Outlined"
                                 Min="0"
                                 Required="true"
                                 RequiredError="Assists is required" />
            </MudForm>
            @if (!string.IsNullOrEmpty(_editStatisticErrorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mt-4">@_editStatisticErrorMessage</MudAlert>
            }
        </DialogContent>
        <DialogActions>
            <MudButton OnClick="CloseEditStatisticDialog" Disabled="@_isSavingStatistic">Cancel</MudButton>
            <MudButton Color="Color.Primary"
                       Variant="Variant.Filled"
                       OnClick="HandleEditStatistic"
                       Disabled="@(!_editStatisticFormIsValid || _isSavingStatistic || _editStatisticTeamPlayerId == 0)">
                @if (_isSavingStatistic)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Saving...</span>
                }
                else
                {
                    <span>Save</span>
                }
            </MudButton>
        </DialogActions>
    </MudDialog>

    @* Delete Statistic Confirmation Dialog *@
    <MudDialog @bind-Visible="_showDeleteStatisticDialog">
        <TitleContent>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Delete" Color="Color.Error" />
                <MudText Typo="Typo.h6">Delete Statistics</MudText>
            </MudStack>
        </TitleContent>
        <DialogContent>
            <MudText Typo="Typo.body1" Class="mb-2">
                Are you sure you want to delete the statistics for the game on <strong>@_deletingStatistic?.GameDate.ToString("MM/dd/yyyy")</strong> with <strong>@_deletingStatistic?.TeamName</strong>?
            </MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                This action cannot be undone. The statistics record will be permanently deleted.
            </MudText>
            @if (!string.IsNullOrEmpty(_deleteStatisticErrorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mt-4">@_deleteStatisticErrorMessage</MudAlert>
            }
        </DialogContent>
        <DialogActions>
            <MudButton OnClick="CloseDeleteStatisticDialog" Disabled="@_isSavingStatistic">Cancel</MudButton>
            <MudButton Color="Color.Error"
                       Variant="Variant.Filled"
                       OnClick="HandleDeleteStatistic"
                       Disabled="@_isSavingStatistic">
                @if (_isSavingStatistic)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Deleting...</span>
                }
                else
                {
                    <span>Delete</span>
                }
            </MudButton>
        </DialogActions>
    </MudDialog>
</MudContainer>

@code {
    [Parameter]
    public int Id { get; set; }

    private PlayerDto? _player;
    private MudForm? _form;
    private bool _formIsValid;
    private bool _isLoading = true;
    private bool _isSaving;
    private bool _isDeleting;
    private string? _errorMessage;
    private int _activeTabIndex;

    private string _name = string.Empty;
    private DateTime? _dateOfBirth;
    private string? _gender;

    // Teams tab state
    private List<TeamPlayerDto> _teams = [];
    private bool _isLoadingTeams;
    private bool _teamsLoaded;
    private string? _teamErrorMessage;

    // Add Team dialog state
    private bool _showAddTeamDialog;
    private MudForm? _addTeamForm;
    private bool _addTeamFormIsValid;
    private string _addTeamName = string.Empty;
    private string _addChampionshipName = string.Empty;
    private DateTime? _addJoinedDate = DateTime.Today;
    private string? _addTeamErrorMessage;
    private bool _isSavingTeam;

    // Edit Team dialog state
    private bool _showEditTeamDialog;
    private MudForm? _editTeamForm;
    private bool _editTeamFormIsValid;
    private TeamPlayerDto? _editingTeam;
    private DateTime? _editLeftDate;
    private string? _editTeamErrorMessage;

    // Remove Team dialog state
    private bool _showRemoveTeamDialog;
    private TeamPlayerDto? _removingTeam;
    private string? _removeTeamErrorMessage;

    // Statistics tab state
    private List<PlayerStatisticDto> _statistics = [];
    private PlayerStatisticAggregateResult _aggregates = PlayerStatisticAggregateResult.Empty();
    private bool _isLoadingStatistics;
    private bool _statisticsLoaded;
    private string? _statisticsErrorMessage;

    // Add Statistic dialog state
    private bool _showAddStatisticDialog;
    private MudForm? _addStatisticForm;
    private bool _addStatisticFormIsValid;
    private int _addStatisticTeamPlayerId;
    private DateTime? _addStatisticGameDate = DateTime.Today;
    private int _addStatisticMinutesPlayed;
    private bool _addStatisticIsStarter;
    private int _addStatisticJerseyNumber = 1;
    private int _addStatisticGoals;
    private int _addStatisticAssists;
    private string? _addStatisticErrorMessage;
    private bool _isSavingStatistic;

    // Edit Statistic dialog state
    private bool _showEditStatisticDialog;
    private MudForm? _editStatisticForm;
    private bool _editStatisticFormIsValid;
    private PlayerStatisticDto? _editingStatistic;
    private int _editStatisticTeamPlayerId;
    private DateTime? _editStatisticGameDate;
    private int _editStatisticMinutesPlayed;
    private bool _editStatisticIsStarter;
    private int _editStatisticJerseyNumber;
    private int _editStatisticGoals;
    private int _editStatisticAssists;
    private string? _editStatisticErrorMessage;

    // Delete Statistic dialog state
    private bool _showDeleteStatisticDialog;
    private PlayerStatisticDto? _deletingStatistic;
    private string? _deleteStatisticErrorMessage;

    private string CurrentUserId => CurrentUserProvider.GetCurrentUser()?.Identity?.Name ?? "system";

    protected override async Task OnInitializedAsync()
    {
        await LoadPlayerAsync();
    }

    private async Task LoadPlayerAsync()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            var result = await PlayerService.GetPlayerByIdAsync(Id);

            if (result.Success && result.Data is not null)
            {
                // Verify ownership - user can only view/edit their own players
                if (!IsCurrentUserOwner(result.Data))
                {
                    _errorMessage = "You do not have permission to view this player.";
                    _player = null;
                    return;
                }

                _player = result.Data;
                _name = _player.Name;
                _dateOfBirth = _player.DateOfBirth;
                _gender = _player.Gender;
            }
            else
            {
                _errorMessage = result.ErrorMessages.FirstOrDefault() ?? "Player not found.";
            }
        }
        catch (Exception)
        {
            _errorMessage = "An unexpected error occurred while loading the player.";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private bool IsCurrentUserOwner(PlayerDto player)
    {
        return string.Equals(player.UserId, CurrentUserId, StringComparison.OrdinalIgnoreCase);
    }

    private async Task HandleUpdate()
    {
        if (_form is null || _player is null)
        {
            return;
        }

        // Verify ownership before update
        if (!IsCurrentUserOwner(_player))
        {
            _errorMessage = "You do not have permission to update this player.";
            return;
        }

        await _form.Validate();

        if (!_formIsValid || !_dateOfBirth.HasValue)
        {
            return;
        }

        _isSaving = true;
        _errorMessage = null;

        try
        {
            var updateDto = new UpdatePlayerDto
            {
                Id = Id,
                Name = _name.Trim(),
                DateOfBirth = _dateOfBirth.Value,
                Gender = string.IsNullOrWhiteSpace(_gender) ? null : _gender,
                PhotoUrl = _player.PhotoUrl
            };

            var result = await PlayerService.UpdatePlayerAsync(Id, updateDto, CurrentUserId);

            if (result.Success)
            {
                NavigationManager.NavigateTo("/players");
            }
            else if (result.ValidationErrors.Count > 0)
            {
                var errors = result.ValidationErrors.SelectMany(e => e.Value);
                _errorMessage = string.Join(" ", errors);
            }
            else
            {
                _errorMessage = result.ErrorMessages.FirstOrDefault() ?? "Unable to update player.";
            }
        }
        catch (Exception)
        {
            _errorMessage = "An unexpected error occurred while updating the player.";
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task HandleDelete()
    {
        if (_player is null)
        {
            return;
        }

        // Verify ownership before delete
        if (!IsCurrentUserOwner(_player))
        {
            _errorMessage = "You do not have permission to delete this player.";
            return;
        }

        var result = await DialogService.ShowMessageBox(
            "Delete Player",
            $"Are you sure you want to delete {_player.Name}? This action cannot be undone.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (result != true)
        {
            return;
        }

        _isDeleting = true;
        _errorMessage = null;

        try
        {
            var deleteResult = await PlayerService.DeletePlayerAsync(Id);

            if (deleteResult.Success)
            {
                NavigationManager.NavigateTo("/players");
            }
            else
            {
                _errorMessage = deleteResult.ErrorMessages.FirstOrDefault() ?? "Unable to delete player.";
            }
        }
        catch (Exception)
        {
            _errorMessage = "An unexpected error occurred while deleting the player.";
        }
        finally
        {
            _isDeleting = false;
        }
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo("/players");
    }

    private async Task OnTabChanged(int index)
    {
        _activeTabIndex = index;

        // Lazy load teams when Teams tab is first accessed (index 1)
        if (index == 1 && !_teamsLoaded && _player is not null)
        {
            await LoadTeamsAsync();
        }

        // Lazy load statistics when Stats tab is first accessed (index 2)
        if (index == 2 && !_statisticsLoaded && _player is not null)
        {
            // Also load teams if not already loaded (needed for dropdown)
            if (!_teamsLoaded)
            {
                await LoadTeamsAsync();
            }
            await LoadStatisticsAsync();
        }
    }

    private async Task LoadTeamsAsync()
    {
        _isLoadingTeams = true;
        _teamErrorMessage = null;

        try
        {
            var result = await TeamPlayerService.GetTeamsByPlayerIdAsync(Id, includeInactive: true);

            if (result.Success && result.Data is not null)
            {
                // Sort by active status (active first), then by JoinedDate DESC
                _teams = result.Data
                    .OrderByDescending(t => t.IsActive)
                    .ThenByDescending(t => t.JoinedDate)
                    .ToList();
                _teamsLoaded = true;
            }
            else
            {
                _teamErrorMessage = result.ErrorMessages.FirstOrDefault() ?? "Unable to load team assignments.";
            }
        }
        catch (Exception)
        {
            _teamErrorMessage = "An unexpected error occurred while loading team assignments.";
        }
        finally
        {
            _isLoadingTeams = false;
        }
    }

    // Add Team Dialog methods
    private void OpenAddTeamDialog()
    {
        _addTeamName = string.Empty;
        _addChampionshipName = string.Empty;
        _addJoinedDate = DateTime.Today;
        _addTeamErrorMessage = null;
        _showAddTeamDialog = true;
    }

    private void CloseAddTeamDialog()
    {
        _showAddTeamDialog = false;
        _addTeamErrorMessage = null;
    }

    private async Task HandleAddTeam()
    {
        if (_addTeamForm is null)
        {
            return;
        }

        await _addTeamForm.Validate();

        if (!_addTeamFormIsValid || !_addJoinedDate.HasValue)
        {
            return;
        }

        _isSavingTeam = true;
        _addTeamErrorMessage = null;

        try
        {
            var createDto = new CreateTeamPlayerDto
            {
                PlayerId = Id,
                TeamName = _addTeamName.Trim(),
                ChampionshipName = _addChampionshipName.Trim(),
                JoinedDate = _addJoinedDate.Value
            };

            var result = await TeamPlayerService.AddPlayerToTeamAsync(createDto, CurrentUserId);

            if (result.Success)
            {
                CloseAddTeamDialog();
                await LoadTeamsAsync();
                Snackbar.Add("Team assignment added successfully.", Severity.Success);
            }
            else if (result.ValidationErrors.Count > 0)
            {
                var errors = result.ValidationErrors.SelectMany(e => e.Value);
                _addTeamErrorMessage = string.Join(" ", errors);
            }
            else
            {
                _addTeamErrorMessage = result.ErrorMessages.FirstOrDefault() ?? "Unable to add team assignment.";
            }
        }
        catch (Exception)
        {
            _addTeamErrorMessage = "An unexpected error occurred while adding the team assignment.";
        }
        finally
        {
            _isSavingTeam = false;
        }
    }

    // Edit Team Dialog methods
    private void OpenEditTeamDialog(TeamPlayerDto team)
    {
        _editingTeam = team;
        _editLeftDate = team.LeftDate;
        _editTeamErrorMessage = null;
        _showEditTeamDialog = true;
    }

    private void CloseEditTeamDialog()
    {
        _showEditTeamDialog = false;
        _editingTeam = null;
        _editLeftDate = null;
        _editTeamErrorMessage = null;
    }

    private async Task HandleEditTeam()
    {
        if (_editingTeam is null)
        {
            return;
        }

        _isSavingTeam = true;
        _editTeamErrorMessage = null;

        try
        {
            var updateDto = new UpdateTeamPlayerDto
            {
                TeamPlayerId = _editingTeam.TeamPlayerId,
                TeamName = _editingTeam.TeamName,
                ChampionshipName = _editingTeam.ChampionshipName,
                JoinedDate = _editingTeam.JoinedDate,
                LeftDate = _editLeftDate
            };

            var result = await TeamPlayerService.UpdateTeamAssignmentAsync(_editingTeam.TeamPlayerId, updateDto, CurrentUserId);

            if (result.Success)
            {
                CloseEditTeamDialog();
                await LoadTeamsAsync();
                Snackbar.Add("Team assignment updated successfully.", Severity.Success);
            }
            else if (result.ValidationErrors.Count > 0)
            {
                var errors = result.ValidationErrors.SelectMany(e => e.Value);
                _editTeamErrorMessage = string.Join(" ", errors);
            }
            else
            {
                _editTeamErrorMessage = result.ErrorMessages.FirstOrDefault() ?? "Unable to update team assignment.";
            }
        }
        catch (Exception)
        {
            _editTeamErrorMessage = "An unexpected error occurred while updating the team assignment.";
        }
        finally
        {
            _isSavingTeam = false;
        }
    }

    // Remove Team Dialog methods
    private void OpenRemoveTeamDialog(TeamPlayerDto team)
    {
        _removingTeam = team;
        _removeTeamErrorMessage = null;
        _showRemoveTeamDialog = true;
    }

    private void CloseRemoveTeamDialog()
    {
        _showRemoveTeamDialog = false;
        _removingTeam = null;
        _removeTeamErrorMessage = null;
    }

    private async Task HandleRemoveTeam()
    {
        if (_removingTeam is null)
        {
            return;
        }

        _isSavingTeam = true;
        _removeTeamErrorMessage = null;

        try
        {
            var result = await TeamPlayerService.RemovePlayerFromTeamAsync(
                _removingTeam.TeamPlayerId,
                DateTime.Today,
                CurrentUserId);

            if (result.Success)
            {
                CloseRemoveTeamDialog();
                await LoadTeamsAsync();
                Snackbar.Add("Player removed from team successfully.", Severity.Success);
            }
            else if (result.ValidationErrors.Count > 0)
            {
                var errors = result.ValidationErrors.SelectMany(e => e.Value);
                _removeTeamErrorMessage = string.Join(" ", errors);
            }
            else
            {
                _removeTeamErrorMessage = result.ErrorMessages.FirstOrDefault() ?? "Unable to remove player from team.";
            }
        }
        catch (Exception)
        {
            _removeTeamErrorMessage = "An unexpected error occurred while removing the player from the team.";
        }
        finally
        {
            _isSavingTeam = false;
        }
    }

    // Statistics methods
    private async Task LoadStatisticsAsync()
    {
        _isLoadingStatistics = true;
        _statisticsErrorMessage = null;

        try
        {
            // Load statistics
            var statisticsResult = await PlayerStatisticService.GetStatisticsByPlayerIdAsync(Id);

            if (statisticsResult.Success && statisticsResult.Data is not null)
            {
                // Sort by GameDate DESC
                _statistics = statisticsResult.Data
                    .OrderByDescending(s => s.GameDate)
                    .ToList();
            }
            else
            {
                _statisticsErrorMessage = statisticsResult.ErrorMessages.FirstOrDefault() ?? "Unable to load statistics.";
            }

            // Load aggregates
            var aggregatesResult = await PlayerStatisticService.GetPlayerAggregatesAsync(Id);

            if (aggregatesResult.Success && aggregatesResult.Data is not null)
            {
                _aggregates = aggregatesResult.Data;
            }

            _statisticsLoaded = true;
        }
        catch (Exception)
        {
            _statisticsErrorMessage = "An unexpected error occurred while loading statistics.";
        }
        finally
        {
            _isLoadingStatistics = false;
        }
    }

    // Add Statistic Dialog methods
    private void OpenAddStatisticDialog()
    {
        _addStatisticTeamPlayerId = _teams.Where(t => t.IsActive).Select(t => t.TeamPlayerId).FirstOrDefault();
        _addStatisticGameDate = DateTime.Today;
        _addStatisticMinutesPlayed = 0;
        _addStatisticIsStarter = false;
        _addStatisticJerseyNumber = 1;
        _addStatisticGoals = 0;
        _addStatisticAssists = 0;
        _addStatisticErrorMessage = null;
        _showAddStatisticDialog = true;
    }

    private void CloseAddStatisticDialog()
    {
        _showAddStatisticDialog = false;
        _addStatisticErrorMessage = null;
    }

    private async Task HandleAddStatistic()
    {
        if (_addStatisticForm is null || !_addStatisticGameDate.HasValue)
        {
            return;
        }

        await _addStatisticForm.Validate();

        if (!_addStatisticFormIsValid || _addStatisticTeamPlayerId == 0)
        {
            return;
        }

        _isSavingStatistic = true;
        _addStatisticErrorMessage = null;

        try
        {
            var createDto = new CreatePlayerStatisticDto
            {
                TeamPlayerId = _addStatisticTeamPlayerId,
                GameDate = _addStatisticGameDate.Value,
                MinutesPlayed = _addStatisticMinutesPlayed,
                IsStarter = _addStatisticIsStarter,
                JerseyNumber = _addStatisticJerseyNumber,
                Goals = _addStatisticGoals,
                Assists = _addStatisticAssists
            };

            var result = await PlayerStatisticService.AddStatisticAsync(createDto, CurrentUserId);

            if (result.Success)
            {
                CloseAddStatisticDialog();
                await LoadStatisticsAsync();
                Snackbar.Add("Statistics added successfully.", Severity.Success);
            }
            else if (result.ValidationErrors.Count > 0)
            {
                var errors = result.ValidationErrors.SelectMany(e => e.Value);
                _addStatisticErrorMessage = string.Join(" ", errors);
            }
            else
            {
                _addStatisticErrorMessage = result.ErrorMessages.FirstOrDefault() ?? "Unable to add statistics.";
            }
        }
        catch (Exception)
        {
            _addStatisticErrorMessage = "An unexpected error occurred while adding statistics.";
        }
        finally
        {
            _isSavingStatistic = false;
        }
    }

    // Edit Statistic Dialog methods
    private void OpenEditStatisticDialog(PlayerStatisticDto statistic)
    {
        _editingStatistic = statistic;
        _editStatisticTeamPlayerId = statistic.TeamPlayerId;
        _editStatisticGameDate = statistic.GameDate;
        _editStatisticMinutesPlayed = statistic.MinutesPlayed;
        _editStatisticIsStarter = statistic.IsStarter;
        _editStatisticJerseyNumber = statistic.JerseyNumber;
        _editStatisticGoals = statistic.Goals;
        _editStatisticAssists = statistic.Assists;
        _editStatisticErrorMessage = null;
        _showEditStatisticDialog = true;
    }

    private void CloseEditStatisticDialog()
    {
        _showEditStatisticDialog = false;
        _editingStatistic = null;
        _editStatisticErrorMessage = null;
    }

    private async Task HandleEditStatistic()
    {
        if (_editStatisticForm is null || _editingStatistic is null || !_editStatisticGameDate.HasValue)
        {
            return;
        }

        await _editStatisticForm.Validate();

        if (!_editStatisticFormIsValid || _editStatisticTeamPlayerId == 0)
        {
            return;
        }

        _isSavingStatistic = true;
        _editStatisticErrorMessage = null;

        try
        {
            var updateDto = new UpdatePlayerStatisticDto
            {
                PlayerStatisticId = _editingStatistic.PlayerStatisticId,
                TeamPlayerId = _editStatisticTeamPlayerId,
                GameDate = _editStatisticGameDate.Value,
                MinutesPlayed = _editStatisticMinutesPlayed,
                IsStarter = _editStatisticIsStarter,
                JerseyNumber = _editStatisticJerseyNumber,
                Goals = _editStatisticGoals,
                Assists = _editStatisticAssists
            };

            var result = await PlayerStatisticService.UpdateStatisticAsync(
                _editingStatistic.PlayerStatisticId,
                updateDto,
                CurrentUserId);

            if (result.Success)
            {
                CloseEditStatisticDialog();
                await LoadStatisticsAsync();
                Snackbar.Add("Statistics updated successfully.", Severity.Success);
            }
            else if (result.ValidationErrors.Count > 0)
            {
                var errors = result.ValidationErrors.SelectMany(e => e.Value);
                _editStatisticErrorMessage = string.Join(" ", errors);
            }
            else
            {
                _editStatisticErrorMessage = result.ErrorMessages.FirstOrDefault() ?? "Unable to update statistics.";
            }
        }
        catch (Exception)
        {
            _editStatisticErrorMessage = "An unexpected error occurred while updating statistics.";
        }
        finally
        {
            _isSavingStatistic = false;
        }
    }

    // Delete Statistic Dialog methods
    private void OpenDeleteStatisticDialog(PlayerStatisticDto statistic)
    {
        _deletingStatistic = statistic;
        _deleteStatisticErrorMessage = null;
        _showDeleteStatisticDialog = true;
    }

    private void CloseDeleteStatisticDialog()
    {
        _showDeleteStatisticDialog = false;
        _deletingStatistic = null;
        _deleteStatisticErrorMessage = null;
    }

    private async Task HandleDeleteStatistic()
    {
        if (_deletingStatistic is null)
        {
            return;
        }

        _isSavingStatistic = true;
        _deleteStatisticErrorMessage = null;

        try
        {
            var result = await PlayerStatisticService.DeleteStatisticAsync(_deletingStatistic.PlayerStatisticId);

            if (result.Success)
            {
                CloseDeleteStatisticDialog();
                await LoadStatisticsAsync();
                Snackbar.Add("Statistics deleted successfully.", Severity.Success);
            }
            else
            {
                _deleteStatisticErrorMessage = result.ErrorMessages.FirstOrDefault() ?? "Unable to delete statistics.";
            }
        }
        catch (Exception)
        {
            _deleteStatisticErrorMessage = "An unexpected error occurred while deleting statistics.";
        }
        finally
        {
            _isSavingStatistic = false;
        }
    }
}
