name: Deploy Application

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        type: choice
        options:
          - dev
          - prod
        default: dev
      image_tag:
        description: "Docker image tag (e.g., v1.0.0, latest)"
        required: false
        default: "latest"
  push:
    branches:
      - main
    paths:
      - "src/**"
      - ".github/workflows/deploy-application.yml"

permissions:
  id-token: write
  contents: read
  packages: write

env:
  AZURE_RESOURCE_GROUP: rg-ghcsampleps-${{ github.event.inputs.environment || 'dev' }}
  CONTAINER_REGISTRY: ghcsampleps${{ github.event.inputs.environment || 'dev' }}acr
  CONTAINER_APP_NAME: ghcsampleps-${{ github.event.inputs.environment || 'dev' }}-app
  IMAGE_NAME: ghcsampleps-web

jobs:
  build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to Azure Container Registry
        uses: azure/docker-login@v2
        with:
          login-server: ${{ env.CONTAINER_REGISTRY }}.azurecr.io
          username: ${{ secrets.AZURE_CLIENT_ID }}
          password: ${{ secrets.AZURE_CLIENT_SECRET }}

      - name: Generate Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ github.event.inputs.image_tag || 'latest' }}
            type=sha,prefix={{branch}}-,format=short
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./src/GhcSamplePs.Web/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:buildcache,mode=max
          build-args: |
            BUILD_CONFIGURATION=Release

      - name: Display image details
        run: |
          echo "ðŸ³ Docker Image Built and Pushed!"
          echo ""
          echo "ðŸ“¦ Image: ${{ env.CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}"
          echo "ðŸ·ï¸  Tags: ${{ steps.meta.outputs.tags }}"
          echo "ðŸ” Digest: ${{ steps.build.outputs.digest }}"

  deploy:
    name: Deploy to Container App
    needs: build
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Update Container App with new image
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            echo "Updating Container App: ${{ env.CONTAINER_APP_NAME }}"

            # Extract the first tag (primary tag)
            IMAGE_TAG="${{ needs.build.outputs.image_tag }}"
            FIRST_TAG=$(echo "$IMAGE_TAG" | head -n 1)

            echo "Using image: $FIRST_TAG"

            # Update container app with new image
            az containerapp update \
              --name ${{ env.CONTAINER_APP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --image "$FIRST_TAG" \
              --output table

      - name: Get Container App URL
        id: app_url
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            FQDN=$(az containerapp show \
              --name ${{ env.CONTAINER_APP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --query "properties.configuration.ingress.fqdn" -o tsv)

            echo "fqdn=$FQDN" >> $GITHUB_OUTPUT
            echo "url=https://$FQDN" >> $GITHUB_OUTPUT

      - name: Verify deployment
        run: |
          echo "âœ… Deployment Complete!"
          echo ""
          echo "ðŸŒ Application URL: ${{ steps.app_url.outputs.url }}"
          echo "ðŸ“¦ Image Digest: ${{ needs.build.outputs.image_digest }}"
          echo ""
          echo "Next steps:"
          echo "1. Navigate to: ${{ steps.app_url.outputs.url }}"
          echo "2. Verify application is running correctly"
          echo "3. Check Application Insights for telemetry"

      - name: Wait for Container App to stabilize
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            echo "Waiting for Container App to be ready..."

            MAX_ATTEMPTS=30
            ATTEMPT=1

            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              STATE=$(az containerapp show \
                --name ${{ env.CONTAINER_APP_NAME }} \
                --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
                --query "properties.runningStatus" -o tsv)

              echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - Status: $STATE"

              if [ "$STATE" = "Running" ]; then
                echo "âœ… Container App is running!"
                exit 0
              fi

              sleep 10
              ATTEMPT=$((ATTEMPT + 1))
            done

            echo "âš ï¸ Container App did not reach Running state within expected time"
            exit 1

      - name: Health check
        run: |
          echo "Performing health check..."

          # Wait a bit for app to fully initialize
          sleep 15

          # Try to access the health endpoint
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.app_url.outputs.url }}/health" || echo "000")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Health check passed (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸ Health check returned HTTP $HTTP_CODE"
            echo "Application may still be starting up. Please verify manually."
          fi

  summary:
    name: Deployment Summary
    needs: [build, deploy]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Display deployment summary
        run: |
          echo "## Deployment Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment: \`${{ github.event.inputs.environment || 'dev' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: \`${{ env.CONTAINER_REGISTRY }}.azurecr.io\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: \`${{ github.event.inputs.image_tag || 'latest' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest**: \`${{ needs.build.outputs.image_digest }}\`" >> $GITHUB_STEP_SUMMARY
